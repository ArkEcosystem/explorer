<?php

declare(strict_types=1);

use App\Http\Livewire\Stats\Chart;
use Illuminate\Support\Carbon;
use Illuminate\Support\Facades\Config;
use Illuminate\Support\Facades\Http;
use Livewire\Livewire;
use function Tests\configureExplorerDatabase;

beforeEach(function (): void {
    configureExplorerDatabase();

    Carbon::setTestNow('2020-01-01 00:00:00');
});

it('should render the component', function () {
    Config::set('explorer.networks.development.canBeExchanged', true);
    Config::set('explorer.networks.development.currency', 'ARK');

    Http::fake([
        'cryptocompare.com/data/pricemultifull*' => Http::response(json_decode(file_get_contents(base_path('tests/fixtures/cryptocompare/pricemultifull.json')), true), 200),
        'cryptocompare.com/data/price*'          => Http::response(['USD' => 0.2907, 'BTC' => 0.00002907], 200),
        'cryptocompare.com/data/histoday*'       => Http::response(json_decode(file_get_contents(base_path('tests/fixtures/cryptocompare/historical.json')), true), 200),
        'cryptocompare.com/data/histohour*'      => Http::response(json_decode(file_get_contents(base_path('tests/fixtures/cryptocompare/histohour.json')), true), 200),
    ]);

    Livewire::test(Chart::class)
        ->set('period', 'day')
        ->assertSee(trans('pages.statistics.chart.price'))
        ->assertSee('0.00002907 BTC')
        ->assertSee('$0.29')
        ->assertSee('13.70%')
        ->assertSee(trans('pages.statistics.chart.market-cap'))
        ->assertSee('$254,260,570.60')
        ->assertSee(trans('pages.statistics.chart.min-price'))
        ->assertSee('1.275 BTC')
        ->assertSee(trans('pages.statistics.chart.max-price'))
        ->assertSee('2.469 BTC')
        ->assertSee('[0.1431,0.1398,0.1399,0.1456,0.1455,0.1457,0.1524,0.1462,0.1429,0.1381,0.1438,0.1407,0.14,0.1392,0.142,0.1486,0.1452,0.1556,0.16,0.1557,0.1523,0.1578,0.1646,0.1545,0.1635,0.1577,0.1562,0.1571,0.1628,0.1576,0.16,0.16,0.1669,0.1743,0.1764,0.1975,0.1967,0.2087,0.2147,0.2004,0.2188,0.2956,0.2755,0.2724,0.2732,0.284,0.2732,0.2425,0.2351,0.2484,0.2248,0.2293,0.2263,0.2265,0.2449,0.2258,0.2031,0.1907,0.1966,0.1947,0.1852,0.1936,0.2092,0.2173,0.216,0.2282,0.2328,0.2158,0.1819,0.1881,0.1881,0.1846,0.0916,0.1062,0.1109,0.1149,0.1065,0.125,0.1328,0.168,0.1595,0.1624,0.1451,0.1543,0.1625,0.1595,0.1629,0.1513,0.1446,0.1366,0.1482,0.1584,0.1558,0.1567,0.1604,0.1621,0.1598,0.1691,0.1637,0.1694,0.167,0.1538,0.1528,0.1529,0.1526,0.1989,0.182,0.1804,0.1735,0.1791,0.1737,0.1665,0.1604,0.1652,0.1672,0.173,0.1878,0.1865,0.184,0.1816,0.1868,0.1897,0.195,0.1996,0.1949,0.1922,0.1933,0.1894,0.1981,0.2066,0.2096,0.1889,0.1836,0.188,0.1905,0.1957,0.1796,0.1959,0.2084,0.2074,0.2069,0.2131,0.2056,0.2247,0.2123,0.2144,0.2274,0.2225,0.2161,0.2161,0.2158,0.2214,0.2182,0.2378,0.2333,0.2338,0.2333,0.2324,0.2389,0.2345,0.2377,0.2361,0.2405,0.2349,0.2507,0.251,0.2449,0.262,0.2763,0.285,0.3004,0.2834,0.2792,0.2823,0.3029,0.2994,0.32,0.3245,0.2969,0.33,0.2822,0.2808,0.2882,0.2601,0.2684,0.2559,0.2597,0.254,0.2809,0.2757,0.2882,0.2874,0.2975,0.3347,0.3294,0.2954,0.33,0.3183,0.3566,0.3368,0.3942,0.4054,0.4529,0.4412,0.4583,0.4607,0.4433,0.4236,0.4231,0.3735,0.403,0.4181,0.4522,0.4282,0.4249,0.4995,0.5938,0.5503,0.5226,0.5128,0.5081,0.5246,0.511,0.5047,0.4796,0.4858,0.4868,0.5191,0.5057,0.5284,0.5467,0.5224,0.479,0.5048,0.4779,0.5056,0.4978,0.533,0.4788,0.4914,0.4467,0.4554,0.4689,0.4725,0.4545,0.4434,0.4074,0.3245,0.3406,0.3135,0.32,0.3147,0.311,0.3452,0.3542,0.3511,0.3994,0.4082,0.3941,0.3547,0.3426,0.3566,0.3504,0.3617,0.3443,0.306,0.2998,0.2775,0.2969,0.3011,0.3025,0.3031,0.2952,0.3014,0.3045,0.2871,0.2735,0.2771,0.2784,0.2806,0.2686,0.2663,0.2789,0.3255,0.2987,0.3266,0.3154,0.3105,0.3014,0.2956,0.2867,0.2991,0.2946,0.2927,0.2704,0.2781]');
});

it('should not render the component', function () {
    Config::set('explorer.networks.development.canBeExchanged', false);
    Config::set('explorer.networks.development.currency', 'ARK');

    Http::fake([
        'cryptocompare.com/data/pricemultifull*' => Http::response(json_decode(file_get_contents(base_path('tests/fixtures/cryptocompare/pricemultifull.json')), true), 200),
        'cryptocompare.com/data/price*'          => Http::response(['USD' => 0.2907, 'BTC' => 0.00002907], 200),
        'cryptocompare.com/data/histoday*'       => Http::response(json_decode(file_get_contents(base_path('tests/fixtures/cryptocompare/historical.json')), true), 200),
        'cryptocompare.com/data/histohour*'      => Http::response(json_decode(file_get_contents(base_path('tests/fixtures/cryptocompare/histohour.json')), true), 200),
    ]);

    Livewire::test(Chart::class)
        ->set('period', 'day')
        ->assertDontSee(trans('pages.statistics.chart.price'))
        ->assertDontSee('0.00002907 BTC')
        ->assertDontSee('$0.29')
        ->assertDontSee('13.70%')
        ->assertDontSee(trans('pages.statistics.chart.market-cap'))
        ->assertDontSee('$254,260,570.60')
        ->assertDontSee(trans('pages.statistics.chart.min-price'))
        ->assertDontSee('1.275 BTC')
        ->assertDontSee(trans('pages.statistics.chart.max-price'))
        ->assertDontSee('2.469 BTC')
        ->assertDontSee('[0.1431,0.1398,0.1399,0.1456,0.1455,0.1457,0.1524,0.1462,0.1429,0.1381,0.1438,0.1407,0.14,0.1392,0.142,0.1486,0.1452,0.1556,0.16,0.1557,0.1523,0.1578,0.1646,0.1545,0.1635,0.1577,0.1562,0.1571,0.1628,0.1576,0.16,0.16,0.1669,0.1743,0.1764,0.1975,0.1967,0.2087,0.2147,0.2004,0.2188,0.2956,0.2755,0.2724,0.2732,0.284,0.2732,0.2425,0.2351,0.2484,0.2248,0.2293,0.2263,0.2265,0.2449,0.2258,0.2031,0.1907,0.1966,0.1947,0.1852,0.1936,0.2092,0.2173,0.216,0.2282,0.2328,0.2158,0.1819,0.1881,0.1881,0.1846,0.0916,0.1062,0.1109,0.1149,0.1065,0.125,0.1328,0.168,0.1595,0.1624,0.1451,0.1543,0.1625,0.1595,0.1629,0.1513,0.1446,0.1366,0.1482,0.1584,0.1558,0.1567,0.1604,0.1621,0.1598,0.1691,0.1637,0.1694,0.167,0.1538,0.1528,0.1529,0.1526,0.1989,0.182,0.1804,0.1735,0.1791,0.1737,0.1665,0.1604,0.1652,0.1672,0.173,0.1878,0.1865,0.184,0.1816,0.1868,0.1897,0.195,0.1996,0.1949,0.1922,0.1933,0.1894,0.1981,0.2066,0.2096,0.1889,0.1836,0.188,0.1905,0.1957,0.1796,0.1959,0.2084,0.2074,0.2069,0.2131,0.2056,0.2247,0.2123,0.2144,0.2274,0.2225,0.2161,0.2161,0.2158,0.2214,0.2182,0.2378,0.2333,0.2338,0.2333,0.2324,0.2389,0.2345,0.2377,0.2361,0.2405,0.2349,0.2507,0.251,0.2449,0.262,0.2763,0.285,0.3004,0.2834,0.2792,0.2823,0.3029,0.2994,0.32,0.3245,0.2969,0.33,0.2822,0.2808,0.2882,0.2601,0.2684,0.2559,0.2597,0.254,0.2809,0.2757,0.2882,0.2874,0.2975,0.3347,0.3294,0.2954,0.33,0.3183,0.3566,0.3368,0.3942,0.4054,0.4529,0.4412,0.4583,0.4607,0.4433,0.4236,0.4231,0.3735,0.403,0.4181,0.4522,0.4282,0.4249,0.4995,0.5938,0.5503,0.5226,0.5128,0.5081,0.5246,0.511,0.5047,0.4796,0.4858,0.4868,0.5191,0.5057,0.5284,0.5467,0.5224,0.479,0.5048,0.4779,0.5056,0.4978,0.533,0.4788,0.4914,0.4467,0.4554,0.4689,0.4725,0.4545,0.4434,0.4074,0.3245,0.3406,0.3135,0.32,0.3147,0.311,0.3452,0.3542,0.3511,0.3994,0.4082,0.3941,0.3547,0.3426,0.3566,0.3504,0.3617,0.3443,0.306,0.2998,0.2775,0.2969,0.3011,0.3025,0.3031,0.2952,0.3014,0.3045,0.2871,0.2735,0.2771,0.2784,0.2806,0.2686,0.2663,0.2789,0.3255,0.2987,0.3266,0.3154,0.3105,0.3014,0.2956,0.2867,0.2991,0.2946,0.2927,0.2704,0.2781]');
});

it('it should filter by year', function () {
    Config::set('explorer.networks.development.canBeExchanged', true);
    Config::set('explorer.networks.development.currency', 'ARK');

    Http::fake([
        'cryptocompare.com/data/pricemultifull*' => Http::response(json_decode(file_get_contents(base_path('tests/fixtures/cryptocompare/pricemultifull.json')), true), 200),
        'cryptocompare.com/data/price*'          => Http::response(['USD' => 0.2907, 'BTC' => 0.00002907], 200),
        'cryptocompare.com/data/histoday*'       => Http::response(json_decode(file_get_contents(base_path('tests/fixtures/cryptocompare/historical.json')), true), 200),
        'cryptocompare.com/data/histohour*'      => Http::response(json_decode(file_get_contents(base_path('tests/fixtures/cryptocompare/histohour.json')), true), 200),
    ]);

    Livewire::test(Chart::class)
        ->set('period', 'year')
        ->assertSee(trans('pages.statistics.chart.price'))
        ->assertSee('0.00002907 BTC')
        ->assertSee('$0.29')
        ->assertSee('13.70%')
        ->assertSee(trans('pages.statistics.chart.market-cap'))
        ->assertSee('$254,260,570.60')
        ->assertSee(trans('pages.statistics.chart.min-price'))
        ->assertSee('1.275 BTC')
        ->assertSee(trans('pages.statistics.chart.max-price'))
        ->assertSee('2.469 BTC')
        ->assertSee('[0.3946,0.4203,0.4181,0.4595,0.443,0.4739,0.4524,0.4522,0.472,0.4156,0.3941,0.3965,0.3683,0.3941,0.3752,0.391,0.4069,0.4162,0.436,0.4003,0.4068,0.4052,0.3965,0.4092,0.4031,0.4024,0.4271,0.3916,0.389,0.4036,0.3767,0.3877,0.3965,0.3957,0.3764,0.3641,0.3432,0.3487,0.4619,0.4167,0.5664,0.5168,0.4891,0.5182,0.4967,0.4844,0.4713,0.623,0.6784,0.6463,0.6513,0.62,0.6382,0.6502,0.5631,0.5614,0.5647,0.5738,0.58,0.5743,0.5753,0.5623,0.528,0.5687,0.553,0.5653,0.5466,0.5764,0.6087,0.6312,0.6132,0.6493,0.6723,0.6676,0.6536,0.6389,0.6306,0.627,0.631,0.6159,0.6337,0.6299,0.6327,0.6044,0.6311,0.6599,0.6761,0.6767,0.6972,0.723,0.6937,0.7257,0.6798,0.6771,0.7081,0.6777,0.6923,0.6708,0.673,0.659,0.6169,0.6194,0.6468,0.6705,0.6105,0.6334,0.6435,0.641,0.6455,0.6312,0.6054,0.5999,0.5777,0.5455,0.5064,0.4849,0.5092,0.5009,0.4691,0.4872,0.4708,0.4852,0.4916,0.4698,0.4722,0.4915,0.46,0.4768,0.429,0.4484,0.4968,0.529,0.5413,0.5762,0.6234,0.6157,0.5806,0.5648,0.5981,0.58,0.6251,0.6179,0.6149,0.6552,0.6478,0.6401,0.6454,0.6298,0.6327,0.5875,0.617,0.6,0.617,0.5764,0.539,0.5695,0.5607,0.6016,0.6032,0.589,0.6141,0.6247,0.614,0.5845,0.621,0.5803,0.5715,0.5717,0.5488,0.5596,0.5245,0.51,0.5179,0.5137,0.5303,0.505,0.4704,0.4372,0.451,0.4659,0.4416,0.4562,0.4348,0.4507,0.4261,0.4318,0.4477,0.4616,0.4409,0.4578,0.407,0.3654,0.3972,0.3943,0.3279,0.3266,0.2804,0.2919,0.3132,0.3155,0.3268,0.3218,0.3257,0.3624,0.4074,0.3874,0.4131,0.3707,0.3878,0.3892,0.3657,0.3412,0.3248,0.3338,0.3195,0.3217,0.3003,0.2822,0.2812,0.2679,0.2421,0.2524,0.2579,0.2517,0.2457,0.2074,0.2112,0.2144,0.214,0.217,0.2261,0.2219,0.2259,0.2273,0.2359,0.2465,0.2334,0.2301,0.2289,0.2081,0.204,0.2032,0.2123,0.2071,0.2078,0.2282,0.216,0.2174,0.2124,0.2235,0.2251,0.233,0.2275,0.2129,0.2287,0.2334,0.2268,0.2197,0.2164,0.2153,0.2279,0.2245,0.2305,0.2243,0.2243,0.2086,0.1666,0.1668,0.1634,0.1699,0.1796,0.1702,0.1752,0.1728,0.1775,0.1775,0.1796,0.1836,0.1776,0.1839,0.1904,0.1866,0.1853,0.1894,0.201,0.2105,0.2109,0.199,0.1943,0.2004,0.1975,0.1935,0.1882,0.1891,0.1837,0.1802,0.1793,0.1961,0.189,0.1976,0.2091,0.2059,0.195,0.1954,0.204,0.2017,0.2171,0.2111,0.2184,0.2239,0.2193,0.2119,0.2214,0.2169,0.2129,0.2191,0.2203,0.2132,0.2054,0.2077,0.2086,0.1976,0.1895,0.1925,0.1767,0.1623,0.1681,0.1525,0.1625,0.1668,0.1784,0.1842,0.1897,0.187,0.1857,0.1803,0.1898,0.1803,0.1759,0.1867,0.1839,0.1898,0.1844,0.1671,0.1683,0.1665,0.1727,0.1669,0.1703,0.1605,0.1435,0.1494,0.1537,0.1552,0.1504,0.1531,0.1536,0.1482,0.1451,0.1442,0.1466,0.1485,0.1493,0.1435,0.1431,0.1398,0.1399,0.1456,0.1455,0.1457,0.1524,0.1462,0.1429,0.1381,0.1438,0.1407,0.14,0.1392,0.142,0.1486,0.1452,0.1556,0.16,0.1557,0.1523,0.1578,0.1646,0.1545,0.1635,0.1577,0.1562,0.1571,0.1628,0.1576,0.16,0.16,0.1669,0.1743,0.1764,0.1975,0.1967,0.2087,0.2147,0.2004,0.2188,0.2956,0.2755,0.2724,0.2732,0.284,0.2732,0.2425,0.2351,0.2484,0.2248,0.2293,0.2263,0.2265,0.2449,0.2258,0.2031,0.1907,0.1966,0.1947,0.1852,0.1936,0.2092,0.2173,0.216,0.2282,0.2328,0.2158,0.1819,0.1881,0.1881,0.1846,0.0916,0.1062,0.1109,0.1149,0.1065,0.125,0.1328,0.168,0.1595,0.1624,0.1451,0.1543,0.1625,0.1595,0.1629,0.1513,0.1446,0.1366,0.1482,0.1584,0.1558,0.1567,0.1604,0.1621,0.1598,0.1691,0.1637,0.1694,0.167,0.1538,0.1528,0.1529,0.1526,0.1989,0.182,0.1804,0.1735,0.1791,0.1737,0.1665,0.1604,0.1652,0.1672,0.173,0.1878,0.1865,0.184,0.1816,0.1868,0.1897,0.195,0.1996,0.1949,0.1922,0.1933,0.1894,0.1981,0.2066,0.2096,0.1889,0.1836,0.188,0.1905,0.1957,0.1796,0.1959,0.2084,0.2074,0.2069,0.2131,0.2056,0.2247,0.2123,0.2144,0.2274,0.2225,0.2161,0.2161,0.2158,0.2214,0.2182,0.2378,0.2333,0.2338,0.2333,0.2324,0.2389,0.2345,0.2377,0.2361,0.2405,0.2349,0.2507,0.251,0.2449,0.262,0.2763,0.285,0.3004,0.2834,0.2792,0.2823,0.3029,0.2994,0.32,0.3245,0.2969,0.33,0.2822,0.2808,0.2882,0.2601,0.2684,0.2559,0.2597,0.254,0.2809,0.2757,0.2882,0.2874,0.2975,0.3347,0.3294,0.2954,0.33,0.3183,0.3566,0.3368,0.3942,0.4054,0.4529,0.4412,0.4583,0.4607,0.4433,0.4236,0.4231,0.3735,0.403,0.4181,0.4522,0.4282,0.4249,0.4995,0.5938,0.5503,0.5226,0.5128,0.5081,0.5246,0.511,0.5047,0.4796,0.4858,0.4868,0.5191,0.5057,0.5284,0.5467,0.5224,0.479,0.5048,0.4779,0.5056,0.4978,0.533,0.4788,0.4914,0.4467,0.4554,0.4689,0.4725,0.4545,0.4434,0.4074,0.3245,0.3406,0.3135,0.32,0.3147,0.311,0.3452,0.3542,0.3511,0.3994,0.4082,0.3941,0.3547,0.3426,0.3566,0.3504,0.3617,0.3443,0.306,0.2998,0.2775,0.2969,0.3011,0.3025,0.3031,0.2952,0.3014,0.3045,0.2871,0.2735,0.2771,0.2784,0.2806,0.2686,0.2663,0.2789,0.3255,0.2987,0.3266,0.3154,0.3105,0.3014,0.2956,0.2867,0.2991,0.2946,0.2927,0.2704,0.2781]');
});
